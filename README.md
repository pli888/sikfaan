# sikfaan

Sikfaan is an R tool for determining the differences between the structure of the 
GigaDB PostgreSQL relational database since they change over time with the 
development of new functionality.

## Install

This package can be installed from its directory root as follows:
```
$ sudo R
R> library(devtools)
R> install()
```

## Usage

To compare the relational schema between two databases, we need to obtain their
contents in SQL format. For testing purposes, there are two SQL files in this 
package called `older.sql` and `newer.sql`. Next, we need to transform the
contents of these sql files into a matrix which can be processed by R:
```
R> newer_mat <- getTableInfo("newer.sql")
R> older_mat <- getTableInfo("older.sql")
```

These two matrices can then be compared using the `compareTables` function which
generates a report in markdown format:
```
R> out <- compareTables(older_mat, newer_mat)
# Output a file containing results
R> write.table(out, file="dif.tab", col.names=FALSE, row.names=FALSE, quote=FALSE)
```

## Generating SQL files for processing by sikfaan

Real SQL files from GigaDB PostgreSQL databases can be generated as follows:

 * `bootstrap.sql` comes from `gigadb-website/ops/configuration/postgresql-conf/bootstrap.sql`
 * `gigadb_local_develop_no_migration.sql` is a SQL dump file that comes from a 
 database generated from `develop` branch code and deployed locally with no Yii 
 migration scripts executed
 * `gigadb_local_develop_with_migration.sql` is a SQL dump file that comes from 
 database generated from `develop` branch code and deployed locally with Yii 
 migration scripts executed
 
To create SQL files from local GigaDB installs, we need to access the `test` 
container: 
```
# Log into bash in the test container to get postgres dumps
$ docker-compose run --rm test bash
# Download sql dump
$ pg_dump -U gigadb -h database -W -F plain gigadb > name_of_file.sql
```

Production and staging GigaDB installations will generate larger SQL file dumps.
These can be generated by connecting to the AWS server as follows:
```
$ ssh -i "~/.ssh/your_aws_key_file.pem" centos@ec2-xx-xxx-xxx-xxx.ap-region.compute.amazonaws.com
$ pg_dump -U gigadb -h localhost -W -F plain gigadb > gigadb_staging.sql
```

The `gigadb_staging.sql` file can then be downloaded using `sftp`.

The `gigadb-website/sql/production_like.pgdmp` file can be converted into a SQL
file using the `pg_restore` tool:
```
# Convert pgdump file to sql file
$ pg_restore -f production_like.sql production_like.pgdmp
```
